{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Relatórios</h2>
    <p>Selecione o período e as categorias para gerar um relatório de totais de entradas e saídas.</p>

    <div class="card">
        <div class="card-body">
            <form method="POST" action="{{ url_for('main.report') }}">
                {{ form.hidden_tag() }}
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            {{ form.start_date.label(class="form-label") }}
                            {{ form.start_date(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            {{ form.end_date.label(class="form-label") }}
                            {{ form.end_date(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form.account.label(class="form-label") }}
                            {{ form.account(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-2 align-self-end">
                        <div class="form-group">
                            {{ form.submit(class="btn btn-primary w-100") }}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if results %}
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4>Resultados</h4>
            <a href="{{ url_for('main.download_report_csv', start_date=request.form.get('start_date'), end_date=request.form.get('end_date'), account=request.form.get('account')) }}" class="btn btn-success">
                <i class="bi bi-download"></i> Baixar CSV
            </a>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Categoria</th>
                        <th class="text-end">Entradas</th>
                        <th class="text-end">Saídas</th>
                        <th class="text-end">Balanço</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category, total_entrada, total_saida in results.items %}
                    <tr>
                        <td>{{ category }}</td>
                        <td class="text-end text-success">R$ {{ "%.2f"|format(total_entrada or 0) }}</td>
                        <td class="text-end text-danger">R$ {{ "%.2f"|format(total_saida or 0) }}</td>
                        {% set balance = (total_entrada or 0) - (total_saida or 0) %}
                        <td class="text-end {% if balance >= 0 %}text-success{% else %}text-danger{% endif %}">R$ {{ "%.2f"|format(balance) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-dark">
                        <td><strong>Total</strong></td>
                        <td class="text-end text-success"><strong>R$ {{ "%.2f"|format(totals.total_entrada) }}</strong></td>
                        <td class="text-end text-danger"><strong>R$ {{ "%.2f"|format(totals.total_saida) }}</strong></td>
                        <td class="text-end {% if totals.balance >= 0 %}text-success{% else %}text-danger{% endif %}"><strong>R$ {{ "%.2f"|format(totals.balance) }}</strong></td>
                    </tr>
                </tfoot>
            </table>
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if results.has_prev %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('main.report', page=results.prev_num, start_date=request.form.get('start_date'), end_date=request.form.get('end_date'), account=request.form.get('account')) }}">Anterior</a></li>
                    {% endif %}
                    {% for page_num in results.iter_pages() %}
                        {% if page_num %}
                            <li class="page-item {% if results.page == page_num %}active{% endif %}"><a class="page-link" href="{{ url_for('main.report', page=page_num, start_date=request.form.get('start_date'), end_date=request.form.get('end_date'), account=request.form.get('account')) }}">{{ page_num }}</a></li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}
                    {% if results.has_next %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('main.report', page=results.next_num, start_date=request.form.get('start_date'), end_date=request.form.get('end_date'), account=request.form.get('account')) }}">Próxima</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    $('.select2').select2({
        placeholder: "Selecione uma ou mais categorias",
        allowClear: true
    });
});
</script>
{% endblock %}
